<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Editor post-imposici√≥n IA</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/editor_post_imposicion.css') }}">
</head>
<body>
  <header class="editor-header">
    <div class="title-area">
      <h1>Editor post-imposici√≥n IA</h1>
      <div class="job-label">Job: <strong>{{ job_id }}</strong></div>
    </div>
    <div class="toolbar" aria-label="Herramientas de vista y alineaci√≥n">
      <div class="toolbar-group" aria-label="Zoom" role="group">
        <button id="zoom-out" type="button" title="Alejar (Ctrl -)" aria-label="Alejar vista">‚àí</button>
        <button id="zoom-reset" type="button" title="Ajustar pliego (Ctrl 0)" aria-label="Ajustar pliego">Ajustar</button>
        <button id="zoom-in" type="button" title="Acercar (Ctrl +)" aria-label="Acercar vista">+</button>
      </div>
      <div class="toolbar-group" aria-label="Acciones r√°pidas" role="group">
        <button id="undo-btn" type="button" title="Deshacer (Ctrl+Z)" aria-label="Deshacer">‚Ü∂</button>
        <button id="redo-btn" type="button" title="Rehacer (Ctrl+Y)" aria-label="Rehacer">‚Ü∑</button>
        <button id="duplicate-btn" type="button" title="Duplicar piezas seleccionadas (Ctrl+D)" aria-label="Duplicar piezas seleccionadas">‚ßâ</button>
      </div>
      <div class="toolbar-group" aria-label="Alineaci√≥n r√°pida">
        <button class="align-btn" data-align="left" type="button" title="Alinear a la izquierda" aria-label="Alinear a la izquierda">‚ü∏</button>
        <button class="align-btn" data-align="center-vertical" type="button" title="Centrar verticalmente" aria-label="Centrar verticalmente">‚á§‚á•</button>
        <button class="align-btn" data-align="right" type="button" title="Alinear a la derecha" aria-label="Alinear a la derecha">‚üπ</button>
        <button class="align-btn" data-align="top" type="button" title="Alinear arriba" aria-label="Alinear arriba">‚ü∞</button>
        <button class="align-btn" data-align="center-horizontal" type="button" title="Centrar horizontalmente" aria-label="Centrar horizontalmente">‚á°‚á£</button>
        <button class="align-btn" data-align="bottom" type="button" title="Alinear abajo" aria-label="Alinear abajo">‚ü±</button>
        <button class="align-btn" data-align="dist-h" type="button" title="Distribuir horizontal" aria-label="Distribuir horizontal">‚ãØ</button>
        <button class="align-btn" data-align="dist-v" type="button" title="Distribuir vertical" aria-label="Distribuir vertical">‚ãÆ</button>
        <button class="align-btn" data-align="center-sheet" type="button" title="Centrar en hoja" aria-label="Centrar en hoja">‚óé</button>
      </div>
      <div class="toolbar-group">
        <button id="save-btn" class="primary" type="button" aria-label="Guardar cambios">Guardar cambios</button>
        <button id="ia-chat-toggle" type="button" aria-label="Mostrar/ocultar asistente IA">ü§ñ IA</button>
      </div>
    </div>
  </header>

  <main class="editor-main">
    <section class="editor-stage" aria-label="Pliego">
      <div class="rulers">
        <div id="ruler-top" class="ruler horizontal"></div>
        <div class="stage-with-rulers">
          <div id="ruler-left" class="ruler vertical"></div>
          <div id="editor-canvas" tabindex="0">
            <div id="sheet-viewport">
              <div id="sheet-zoom-container">
                <div id="sheet-pan-container"></div>
              </div>
              <div id="guides-layer"></div>
              <div id="selection-marquee" hidden></div>
            </div>
          </div>
        </div>
      </div>
      <div id="piece-tooltip" role="status" aria-live="polite"></div>

      <!-- Panel de Asistente IA -->
      <div id="ia-chat-panel" class="ia-chat hidden">
        <div class="ia-chat-header">
          <span>Asistente IA</span>
          <button id="ia-chat-close" type="button" aria-label="Cerrar asistente IA">‚úï</button>
        </div>

        <div id="ia-chat-history" class="ia-chat-history"></div>

        <div class="ia-chat-input-area">
          <input id="ia-chat-input" type="text" placeholder="Escribe una instrucci√≥n sobre el montaje...">
          <button id="ia-chat-send" type="button">Enviar</button>
        </div>

        <button id="ia-chat-apply" type="button" class="ia-chat-apply" disabled>
          Aplicar cambios IA
        </button>
      </div>
    </section>

    <aside class="editor-sidebar" aria-label="Panel de propiedades">
      <fieldset>
        <legend>Acciones</legend>
        <label for="asset-select">Reemplazar pieza por:</label>
        <select id="asset-select"></select>
        <button type="button" id="replace-btn">Reemplazar pieza seleccionada</button>
        <button type="button" id="swap-btn">Intercambiar piezas seleccionadas</button>
      </fieldset>

      <fieldset id="properties-panel">
        <legend>Propiedades de la pieza</legend>
        <div class="property-row">
          <label for="prop-x">X (mm)</label>
          <input id="prop-x" type="number" step="0.1">
        </div>
        <div class="property-row">
          <label for="prop-y">Y (mm)</label>
          <input id="prop-y" type="number" step="0.1">
        </div>
        <div class="property-row">
          <label for="prop-w">Ancho (mm)</label>
          <input id="prop-w" type="number" step="0.1" min="0">
        </div>
        <div class="property-row">
          <label for="prop-h">Alto (mm)</label>
          <input id="prop-h" type="number" step="0.1" min="0">
        </div>
        <div class="property-row">
          <label for="prop-rot">Rotaci√≥n (¬∞)</label>
          <input id="prop-rot" type="number" step="1">
        </div>
        <div class="property-row checkbox-row">
          <label for="prop-locked">Bloquear pieza</label>
          <input id="prop-locked" type="checkbox">
        </div>
        <hr>
        <div class="property-row">
          <label>Medida final (trim)</label>
          <input id="prop-trim-w" type="number" step="0.1" readonly>
          <input id="prop-trim-h" type="number" step="0.1" readonly>
        </div>
        <div class="property-row">
          <label>Sangrado (mm por lado)</label>
          <input id="prop-bleed" type="number" step="0.1" readonly>
        </div>
        <div class="property-row checkbox-row">
          <label for="toggle-trim-box">Ver caja de medida</label>
          <input id="toggle-trim-box" type="checkbox" checked>
        </div>
        <div class="property-row checkbox-row">
          <label for="toggle-bleed-box">Ver caja de sangrado</label>
          <input id="toggle-bleed-box" type="checkbox" checked>
        </div>
        <p class="panel-hint">Seleccion√° una pieza para editarla. Los cambios se aplican al confirmar o salir del campo.</p>
      </fieldset>

      <fieldset>
        <legend>Espacios entre piezas</legend>
        <div class="property-row">
          <label for="gap-h-mm">Separaci√≥n horizontal (mm)</label>
          <input id="gap-h-mm" type="number" step="0.1" value="0">
        </div>
        <div class="property-row">
          <label for="gap-v-mm">Separaci√≥n vertical (mm)</label>
          <input id="gap-v-mm" type="number" step="0.1" value="0">
        </div>
        <button type="button" id="gap-apply-selection">Aplicar a selecci√≥n</button>
        <button type="button" id="gap-apply-sheet">Aplicar a todo el pliego</button>
        <p class="panel-hint">
          Seleccion√° varias piezas y ajust√° los espacios exactos entre ellas en mm.
        </p>
      </fieldset>

      <fieldset>
        <legend>Informaci√≥n</legend>
        <div id="grid-info"></div>
        <div id="sheet-info"></div>
      </fieldset>

      <div class="links">
        <a id="pdf-link" href="#" target="_blank" rel="noopener">Abrir PDF editado</a>
        <a id="preview-link" href="#" target="_blank" rel="noopener">Abrir preview editada</a>
      </div>
      <div id="editor-status" aria-live="polite"></div>
    </aside>
  </main>

  <footer class="status-bar" aria-label="Barra de estado del editor">
    <div id="status-sheet-size">‚Äî</div>
    <div id="status-piece-count">‚Äî</div>
    <div id="status-breakdown">‚Äî</div>
    <div id="status-occupancy">‚Äî</div>
    <div id="status-warnings">‚Äî</div>
  </footer>

  <div id="notification-area"></div>

  {% if layout %}
  <script>
    window.layoutIA = {{ layout | tojson }};
  </script>
  {% endif %}
  <script>
    window.jobIdIA = "{{ job_id }}";
  </script>
  <script src="{{ url_for('static', filename='js/editor_post_imposicion.js') }}"></script>
</body>
</html>
