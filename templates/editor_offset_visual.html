<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Editor visual IA - Montaje Offset</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/editor_offset_visual.css') }}">
</head>
<body>
  <header class="editor-header">
    <div>
      <h1>Editor visual IA</h1>
      <p class="subtitle">
        Defin√≠ primero tus <strong>Trabajos l√≥gicos</strong> (medida final, copias y sangrado),
        luego gener√° los <strong>slots</strong> con IA, acomodalos visualmente y por √∫ltimo
        asign√° los PDFs y gener√° el montaje final.
      </p>
    </div>
    <div class="header-actions">
      <a class="btn" href="{{ url_for('routes.index') }}">Volver al inicio</a>
    </div>
  </header>

  <main class="editor-layout">
    <section class="sheet-wrapper">
      <div class="sheet-toolbar">
        <button id="btn-save" class="btn btn-primary">Guardar montaje</button>
        <button id="btn-auto" class="btn" title="Usa las medidas de los trabajos l√≥gicos para crear los cuadros en el pliego">Generar slots con IA</button>
        <button id="btn-new-slot" class="btn" title="A√±ade un cuadro manualmente">A√±adir slot</button>
        <button id="btn-dup-slot" class="btn" title="Duplica el slot seleccionado">Duplicar selecci√≥n</button>
        <button id="btn-del-slot" class="btn" title="Elimina el slot seleccionado">Borrar selecci√≥n</button>
        <button id="btn-group-slots" class="btn btn-secondary" type="button">Agrupar selecci√≥n</button>
        <button id="btn-ungroup-slots" class="btn btn-secondary" type="button">Desagrupar selecci√≥n</button>
        <div class="face-toggle">
          <span class="muted">Cara:</span>
          <label><input type="radio" name="face" value="front" id="face-front"> Frente</label>
          <label><input type="radio" name="face" value="back" id="face-back"> Dorso</label>
          <button id="btn-duplicate-face" class="btn btn-secondary" type="button">Duplicar pliego a dorso</button>
        </div>
      </div>
      <div class="sheet-subtoolbar">
        <div class="control-block">
          <strong>Snap:</strong>
          <label><input type="checkbox" id="snap-slots"> Slots</label>
          <label><input type="checkbox" id="snap-margins"> M√°rgenes</label>
          <label><input type="checkbox" id="snap-grid"> Grid 5mm</label>
          <label class="inline-input">Sensibilidad
            <input type="number" id="snap-tolerance" step="0.1" min="0" value="3">
            <span class="unit">mm</span>
          </label>
        </div>
        <div class="control-block spacing-controls">
          <strong>Espaciado:</strong>
          <label class="inline-input">Horizontal
            <input type="number" id="spacing-x" step="0.1" value="4">
            <span class="unit">mm</span>
          </label>
          <label class="inline-input">Vertical
            <input type="number" id="spacing-y" step="0.1" value="3">
            <span class="unit">mm</span>
          </label>
          <button id="btn-spacing-apply-all" class="btn btn-secondary btn-small" type="button">Aplicar a todos</button>
          <button id="btn-spacing-rows" class="btn btn-small" type="button">Solo filas</button>
          <button id="btn-spacing-cols" class="btn btn-small" type="button">Solo columnas</button>
          <button id="btn-spacing-live" class="btn btn-small" type="button">LIVE ON</button>
        </div>
      </div>
      <div class="zoom-controls">
        <button type="button" id="zoom-out" class="btn btn-small">-</button>
        <span id="zoom-label" class="muted">100%</span>
        <button type="button" id="zoom-in" class="btn btn-small">+</button>
      </div>
      <div id="sheet-canvas" class="sheet-canvas">
        <div id="sheet" class="sheet"></div>
      </div>
    </section>

    <aside class="side-panel">
      <details class="panel-accordion panel-basic" open>
        <summary>Pliego y m√°rgenes</summary>
        <h2>Pliego</h2>
        <label>Ancho pliego (mm)
          <input type="number" id="sheet-w" step="1" min="100">
        </label>
        <label>Alto pliego (mm)
          <input type="number" id="sheet-h" step="1" min="100">
        </label>
        <label>Formato r√°pido
          <select id="sheet-preset">
            <option value="">Personalizado</option>
            <option value="640x880">640 √ó 880 mm</option>
            <option value="700x1000">700 √ó 1000 mm</option>
            <option value="320x450">320 √ó 450 mm</option>
          </select>
        </label>
      </details>
      <details class="panel-accordion panel-works">
        <summary>Trabajos l√≥gicos (opcional ‚Äì solo para IA de slots)</summary>
        <div class="panel-header">
          <h2>Trabajos l√≥gicos</h2>
          <button id="btn-new-work" class="btn btn-small">Nuevo trabajo</button>
        </div>
        <div id="works-list" class="list"></div>
        <div class="work-form" id="work-form">
          <h3>Editar trabajo</h3>
          <label>Nombre <input type="text" id="work-name"></label>
          <div class="grid-2">
            <label>Ancho (mm) <input type="number" id="work-w" step="0.1"></label>
            <label>Alto (mm) <input type="number" id="work-h" step="0.1"></label>
          </div>
          <label>Copias deseadas <input type="number" id="work-copies" min="1" value="1"></label>
          <label>Sangrado por defecto (mm) <input type="number" id="work-bleed" step="0.1" value="0"></label>
          <label><input type="checkbox" id="work-has-bleed"> El PDF ya tiene sangrado</label>
          <div class="form-actions">
            <button id="btn-save-work" class="btn btn-primary">Guardar trabajo</button>
            <button id="btn-delete-work" class="btn btn-danger">Eliminar trabajo</button>
          </div>
        </div>
      </details>

      <details class="panel-accordion panel-designs" open>
        <summary>Dise√±os (PDF) <span class="muted">Sub√≠ tus PDFs y defin√≠ formas por pliego para cada dise√±o.</span></summary>
        <form id="upload-form">
          <label for="design-work-select" class="muted">Asignar PDFs al trabajo l√≥gico (opcional)</label>
          <select id="design-work-select" name="work_id">
            <option value="">-- Sin trabajo espec√≠fico --</option>
          </select>
          <input type="file" id="design-files" name="files" accept="application/pdf" multiple>
          <button type="submit" class="btn btn-secondary">Subir PDFs</button>
        </form>
        <ul id="designs-list" class="list"></ul>
      </details>

      <details class="panel-accordion panel-imposition">
        <summary>Modo de imposici√≥n</summary>
        <div id="imposition-engine-panel">
          <h2>Modo de imposici√≥n</h2>
          <p class="muted">Eleg√≠ el motor y aplicalo sin perder la edici√≥n manual.</p>
          <label><input type="radio" name="imposition-engine" value="repeat"> Step &amp; Repeat PRO</label>
          <label><input type="radio" name="imposition-engine" value="nesting"> Nesting PRO</label>
          <label><input type="radio" name="imposition-engine" value="hybrid"> H√≠brido (Nesting PRO ‚Üí Step &amp; Repeat si sobra espacio)</label>
          <p class="muted" id="imposition-engine-hint"></p>
          <p class="muted">üí° Tip: Pod√©s usar estos motores aunque no tengas trabajos l√≥gicos. Solo necesit√°s subir PDFs y definir ‚Äúformas por pliego‚Äù en Dise√±os (PDF).</p>
          <button id="btn-apply-imposition" class="btn btn-secondary" type="button">Aplicar motor</button>
          <p class="muted hidden" id="imposition-warning">Configura al menos un dise√±o con sus formas por pliego antes de aplicar la imposici√≥n.</p>
        </div>
      </details>

      <details class="panel-accordion panel-advanced">
        <summary>Ajustes avanzados de slots</summary>
        <section class="panel-block" id="step-repeat-panel">
          <h2>Step &amp; Repeat PRO</h2>
          <p class="muted" id="step-repeat-help">
            Seleccion√° un slot maestro y defin√≠ c√≥mo repetirlo en grilla.
          </p>

          <div class="form-grid">
            <label>Filas
              <input type="number" id="sr-rows" min="1" step="1" value="1">
            </label>
            <label>Columnas
              <input type="number" id="sr-cols" min="1" step="1" value="1">
            </label>
          </div>

          <div class="form-grid">
            <label>Separaci√≥n H (mm)
              <input type="number" id="sr-gap-h" step="0.1" value="0">
            </label>
            <label>Separaci√≥n V (mm)
              <input type="number" id="sr-gap-v" step="0.1" value="0">
            </label>
          </div>

          <label>M√©todo de distribuci√≥n
            <select id="sr-mode">
              <option value="free">Free mode (usar posici√≥n del slot maestro)</option>
              <option value="center">Center block (centrar el bloque en el pliego)</option>
              <option value="align-left">Align left</option>
              <option value="align-right">Align right</option>
              <option value="align-top">Align top</option>
              <option value="align-bottom">Align bottom</option>
            </select>
          </label>

          <label>
            <input type="checkbox" id="sr-auto-margin" checked>
            Usar margen autom√°tico del pliego
          </label>

          <label>Rotaci√≥n masiva
            <select id="sr-rotation">
              <option value="keep">Mantener rotaci√≥n del slot maestro</option>
              <option value="0">0¬∞</option>
              <option value="90">90¬∞</option>
              <option value="180">180¬∞</option>
              <option value="270">270¬∞</option>
            </select>
          </label>

          <label>Asignar PDF
            <select id="sr-assign-pdf-mode">
              <option value="same">Usar el mismo PDF del slot maestro</option>
              <option value="none">Sin PDF (solo cuadros vac√≠os)</option>
            </select>
          </label>

          <label>Comportamiento
            <select id="sr-group-mode">
              <option value="grouped">Bloque agrupado (mover como grupo)</option>
              <option value="independent">Editable slot por slot</option>
            </select>
          </label>

          <label>
            <input type="checkbox" id="sr-copy-bleed" checked>
            Copiar sangrado y marcas de corte del slot maestro
          </label>

          <div class="form-grid">
            <label>Ajuste fino X (mm)
              <input type="number" id="sr-nudge-x" step="0.1" value="0">
            </label>
            <label>Ajuste fino Y (mm)
              <input type="number" id="sr-nudge-y" step="0.1" value="0">
            </label>
          </div>

          <div class="form-grid">
            <label>Offset X (mm)
              <input type="number" id="sr-offset-x" step="0.1" value="0">
            </label>
            <label>Offset Y (mm)
              <input type="number" id="sr-offset-y" step="0.1" value="0">
            </label>
          </div>

          <div class="form-grid">
            <label>Margen superior (mm)
              <input type="number" id="sr-top-margin" step="0.1" value="0">
            </label>
            <label>Margen inferior (mm)
              <input type="number" id="sr-bottom-margin" step="0.1" value="0">
            </label>
          </div>

          <div class="form-grid">
            <label>Margen izquierdo (mm)
              <input type="number" id="sr-left-margin" step="0.1" value="0">
            </label>
            <label>Margen derecho (mm)
              <input type="number" id="sr-right-margin" step="0.1" value="0">
            </label>
          </div>

          <button type="button" id="sr-generate" class="btn btn-secondary">
            Generar Step &amp; Repeat
          </button>
        </section>

        <section class="panel-block">
          <h2>Separaci√≥n entre slots</h2>
          <div class="grid-2">
            <label>gap_x (mm) <input type="number" id="gap-x" step="0.1" value="0"></label>
            <label>gap_y (mm) <input type="number" id="gap-y" step="0.1" value="0"></label>
          </div>
          <button id="btn-apply-gap" class="btn btn-secondary">Aplicar separaci√≥n</button>
          <p class="muted">Si hay 2+ slots seleccionados, la separaci√≥n se aplica solo a ellos. Sin selecci√≥n, afecta a todos los slots.</p>
        </section>

        <section class="panel-block">
          <h2>Propiedades del slot</h2>
          <div id="slot-none" class="muted">Selecciona un slot para editarlo.</div>
          <div id="slot-form" class="slot-form hidden">
            <label>X (mm) <input type="number" id="slot-x" step="0.1"></label>
            <label>Y (mm) <input type="number" id="slot-y" step="0.1"></label>
            <label>Ancho (mm) <input type="number" id="slot-w" step="0.1"></label>
            <label>Alto (mm) <input type="number" id="slot-h" step="0.1"></label>
            <label>Rotaci√≥n (¬∞) <input type="number" id="slot-rot" step="1" value="0"></label>
            <label>Bleed (mm) <input type="number" id="slot-bleed" step="0.1" value="0"></label>
            <label><input type="checkbox" id="slot-crop"> Marcas de corte</label>
            <label><input type="checkbox" id="slot-locked"> Bloquear</label>
            <label>Trabajo l√≥gico
              <select id="slot-work"></select>
            </label>
            <label>PDF asignado
              <select id="slot-design"></select>
            </label>
            <button id="btn-apply-slot" class="btn btn-primary">Aplicar cambios</button>
            <button id="btn-apply-design-selection" class="btn btn-secondary">Aplicar PDF a slots seleccionados</button>
            <p class="muted">Selecciona varios slots con Ctrl/‚åò/Shift + clic y usa este bot√≥n para asignarles el mismo PDF.</p>
          </div>
        </section>
      </details>

      <details class="panel-accordion panel-ctp">
        <summary>Producci√≥n / CTP</summary>

        <p class="muted">
          Este modo ajusta el montaje para salida final a plancha offset:
          centrado, con pinza inferior y listo para CTP.
        </p>

        <label>Pinza inferior (mm)
          <input type="number" id="ctp-gripper-mm" min="0" step="1" value="40">
        </label>

        <label class="checkbox-inline">
          <input type="checkbox" id="ctp-show-guide">
          Mostrar zona de pinza en el canvas
        </label>

        <label class="checkbox-inline">
          <input type="checkbox" id="ctp-lock-after" checked>
          Bloquear slots despu√©s de aplicar
        </label>

        <div class="form-actions">
          <button type="button" id="btn-ctp-apply" class="btn btn-secondary">
            Aplicar Producci√≥n / CTP
          </button>
          <button type="button" id="btn-ctp-disable" class="btn btn-small">
            Quitar ajustes CTP
          </button>
        </div>

        <hr>

        <label class="checkbox-inline">
          <input type="checkbox" id="ctp-marks-registro">
          Marcas de registro CMYK profesionales
        </label>

        <label class="checkbox-inline">
          <input type="checkbox" id="ctp-strip-cmyk">
          Tira de control CMYK superior (ancho del bloque)
        </label>

        <h3 class="panel-subtitle">Texto t√©cnico en pinza</h3>

        <label>Nombre del trabajo
          <input type="text" id="ctp-job-name" placeholder="Ej: ETIQUETA DULCITA 1L">
        </label>

        <label>Cliente (opcional)
          <input type="text" id="ctp-client" placeholder="Ej: AGS">
        </label>

        <label>Observaciones
          <input type="text" id="ctp-notes" placeholder="Ej: Tirada 25.000 ‚Äì 4/0 CMYK">
        </label>

        <label class="checkbox-inline">
          <input type="checkbox" id="ctp-auto-cmyk" checked>
          Generar texto t√©cnico CMYK autom√°tico (C M Y K)
        </label>

        <label>Texto adicional libre
          <textarea id="ctp-extra-text" rows="2" placeholder="Notas t√©cnicas extra, versi√≥n, fecha, etc."></textarea>
        </label>
      </details>

      <details class="panel-accordion panel-export-settings" open>
        <summary>Salida / Preprensa</summary>

        <label class="inline-input">Sangrado real (mm)
          <input type="number" id="export-bleed-mm" min="0" step="0.1">
        </label>

        <label class="checkbox-inline">
          <input type="checkbox" id="export-crop-marks">
          Marcas de corte
        </label>

        <div class="form-actions">
          <button id="export-apply-global" class="btn btn-secondary" type="button">Aplicar a todos</button>
        </div>

        <div id="design-export-list" class="design-export-list"></div>
      </details>

      <details class="panel-accordion panel-output" open>
        <summary>Salida final</summary>
        <div class="form-actions">
          <button id="btn-preview" class="btn btn-secondary">Generar preview</button>
          <button id="btn-pdf" class="btn btn-secondary">Generar PDF final</button>
        </div>
        <div class="preview-area">
          <div>
            <h3>Preview</h3>
            <img id="preview-image" alt="Preview" class="preview-image" />
          </div>
          <div>
            <h3>PDF generado</h3>
            <div id="pdf-output" class="pdf-output"></div>
          </div>
        </div>
      </details>
    </aside>
  </main>

  <script>
    window.INITIAL_LAYOUT_JSON = {{ layout_json|tojson|safe }};
    window.JOB_ID = {{ job_id|tojson|safe }};
  </script>
  <script src="{{ url_for('static', filename='js/editor_offset_visual.js') }}"></script>
</body>
</html>
