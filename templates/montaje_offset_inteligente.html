<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Montaje Offset Inteligente</title>
</head>
<body>
  <h1>Montaje Offset Inteligente</h1>
  <form method="POST" enctype="multipart/form-data">
    <label>Subir de 1 a 5 archivos PDF:</label>
    <input type="file" name="archivos[]" accept=".pdf" multiple required>
    <div id="repeticiones-container"></div>
    <script>
      document
        .querySelector('input[name="archivos[]"]')
        .addEventListener('change', function (e) {
          const container = document.getElementById('repeticiones-container');
          container.innerHTML = '';
          [...this.files].forEach((file, index) => {
            const div = document.createElement('div');
            div.innerHTML = `
        <label>${file.name} - Cantidad de repeticiones:</label>
        <input type="number" name="repeticiones_${index}" min="1" value="1" required>
        <input type="hidden" name="nombre_archivo_${index}" value="${file.name}">
        <br><br>
      `;
            container.appendChild(div);
          });
        });
    </script>
    <br><br>
    <label>Seleccionar tamaño de pliego:</label>
    <select name="pliego">
      <option value="640x880">640x880 mm</option>
      <option value="700x1000">700x1000 mm</option>
      <option value="personalizado">Personalizado</option>
    </select>
    <div id="pliego-personalizado" style="display:none;">
      <label>Ancho del pliego (mm):</label>
      <input type="number" name="ancho_pliego_custom" step="0.01">
      <label>Alto del pliego (mm):</label>
      <input type="number" name="alto_pliego_custom" step="0.01">
    </div>
    <br><br>
    <label>Separación doble corte (mm):</label>
    <input type="number" name="separacion" value="4" step="0.01">
    <br>
    <label>Espaciado horizontal (mm):</label>
    <input type="number" name="espaciado_horizontal" value="0" step="0.01">
    <br>
    <label>Espaciado vertical (mm):</label>
    <input type="number" name="espaciado_vertical" value="0" step="0.01">
    <br>
    <label>
      <input type="checkbox" name="cutmarks_por_forma">
      Añadir marcas de corte por forma (usa la misma longitud que el sangrado)
    </label>
    <br>
    <small>Si el sangrado efectivo es 0 mm, no se dibujarán marcas.</small>
    <br>
    <label>Margen izquierdo (mm):</label>
    <input type="number" name="margen_izq" value="10" step="0.01">
    <br>
    <label>Margen derecho (mm):</label>
    <input type="number" name="margen_der" value="10" step="0.01">
    <br>
    <label>Margen superior (mm):</label>
    <input type="number" name="margen_sup" value="10" step="0.01">
    <br>
    <label>Margen inferior (mm):</label>
    <input type="number" name="margen_inf" value="10" step="0.01">
    <br>

    <fieldset style="margin-top:10px;">
      <legend>Sangrado</legend>
      <label><input type="radio" name="modo_sangrado" value="original" checked> Usar sangrado original del archivo</label><br>
      <label><input type="radio" name="modo_sangrado" value="add"> Añadir sangrado de: <input type="number" name="sangrado_add" min="0" step="0.1" disabled> mm</label><br>
      <label><input type="radio" name="modo_sangrado" value="replace"> Reemplazar sangrado existente con: <input type="number" name="sangrado_replace" min="0" step="0.1" disabled> mm</label>
    </fieldset>

    <label><input type="checkbox" name="centrar" checked> Centrar montaje en pliego</label><br>
    <label>Estrategia de montaje:</label>
    <select name="estrategia">
      <option value="flujo">Flujo (auto)</option>
      <option value="grid">Grid (filas/columnas o celda fija)</option>
      <option value="maxrects">MaxRects (anidado eficiente)</option>
    </select>

    <!-- Controles comunes: mantener márgenes, separaciones, etc. -->

    <!-- Grupo Flujo -->
    <div id="grupo-flujo">
      <label><input type="checkbox" name="alinear_filas" checked title="Alinea por la altura mayor de cada fila"> Alinear por filas</label>
      <label><input type="checkbox" name="preferir_horizontal" title="Si hay rotación, prioriza ancho>alto"> Preferir orientación horizontal</label>
    </div>

    <!-- Grupo Grid -->
    <div id="grupo-grid" style="display:none;">
      <div>
        <label>Filas (opcional): <input type="number" name="filas" min="0" step="1" value="0"></label>
        <label>Columnas (opcional): <input type="number" name="columnas" min="0" step="1" value="0"></label>
      </div>
      <div>
        <small>O usar celda fija (sin reescalar):</small><br>
        <label>Ancho celda (mm): <input type="number" name="celda_ancho" min="0" step="0.1" value="0"></label>
        <label>Alto celda (mm): <input type="number" name="celda_alto" min="0" step="0.1" value="0"></label>
      </div>
      <label><input type="checkbox" name="preferir_horizontal" title="Si hay rotación, prioriza ancho>alto"> Preferir orientación horizontal</label>
    </div>

    <!-- Grupo MaxRects -->
    <div id="grupo-maxrects" style="display:none;">
      <small>Consejo: activar “Ordenar por tamaño” para mejor aprovechamiento.</small><br>
      <label><input type="checkbox" name="ordenar_tamano" checked title="Coloca primero piezas grandes para reducir huecos"> Ordenar por tamaño</label>
    </div>

    <details style="margin-top:12px;">
      <summary>Opciones avanzadas (Offset)</summary>
      <div style="margin-top:8px;">
        <label>Reserva pinza (mm): <input type="number" name="pinza_mm" min="0" step="0.1" value="0" title="Reserva en el borde de pinza (parte inferior del pliego en orientación de trabajo)"></label>
        <label>Reserva lateral (mm): <input type="number" name="lateral_mm" min="0" step="0.1" value="0" title="Reserva lateral para pinza/guía lateral"></label>
        <div style="margin-top:6px;">
          <label><input type="checkbox" name="marcas_registro"> Añadir marcas de registro</label>
          <label><input type="checkbox" name="marcas_corte"> Añadir marcas de corte</label>
        </div>
        <div style="margin-top:6px;">
          <label><input type="checkbox" name="debug_grilla"> Mostrar guías (debug)</label>
        </div>
      </div>
    </details>

    <br>
    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button id="btn-preview" type="button">Vista previa</button>
      <button id="btn-generate" type="submit">Generar PDF</button>
      <button id="btn-reset" type="reset">Actualizar formulario</button>
    </div>
  </form>

  <hr>

  <div id="preview-wrap">
    <div id="loader" style="display:none;">Generando vista previa...</div>
    <div id="preview-panel" style="margin-top:10px;"></div>
    <div id="resumen-panel" style="margin-top:10px;"></div>
  </div>

  <script>
    document.querySelector('select[name="pliego"]').addEventListener('change', function() {
      document.getElementById('pliego-personalizado').style.display =
        this.value === 'personalizado' ? 'block' : 'none';
    });

    const selE = document.querySelector('select[name="estrategia"]');
    const gFlujo = document.getElementById('grupo-flujo');
    const gGrid = document.getElementById('grupo-grid');
    const gMR = document.getElementById('grupo-maxrects');
    const celdaAncho = document.querySelector('input[name="celda_ancho"]');
    const celdaAlto = document.querySelector('input[name="celda_alto"]');
    const filas = document.querySelector('input[name="filas"]');
    const columnas = document.querySelector('input[name="columnas"]');
    const radiosSangrado = document.querySelectorAll('input[name="modo_sangrado"]');

    function actualizarSangradoInputs() {
      const modo = document.querySelector('input[name="modo_sangrado"]:checked').value;
      document.querySelector('input[name="sangrado_add"]').disabled = modo !== 'add';
      document.querySelector('input[name="sangrado_replace"]').disabled = modo !== 'replace';
    }
    radiosSangrado.forEach(r => r.addEventListener('change', actualizarSangradoInputs));
    actualizarSangradoInputs();

    function setGroupState(group, active) {
      group.style.display = active ? 'block' : 'none';
      group.querySelectorAll('input').forEach(inp => inp.disabled = !active);
    }

    function toggleByStrategy() {
      const v = selE.value;
      setGroupState(gFlujo, v === 'flujo');
      setGroupState(gGrid, v === 'grid');
      setGroupState(gMR, v === 'maxrects');
      if (v === 'grid') toggleGridInputs();
    }

    function toggleGridInputs() {
      const usarCelda = parseFloat(celdaAncho.value) > 0 || parseFloat(celdaAlto.value) > 0;
      filas.disabled = usarCelda;
      columnas.disabled = usarCelda;
    }

    selE.addEventListener('change', toggleByStrategy);
    celdaAncho.addEventListener('input', toggleGridInputs);
    celdaAlto.addEventListener('input', toggleGridInputs);
    toggleByStrategy();
    toggleGridInputs();

    const form = document.querySelector('form');
    const btnPreview = document.getElementById('btn-preview');
    const btnGenerate = document.getElementById('btn-generate');
    const btnReset = document.getElementById('btn-reset');
    const loader = document.getElementById('loader');
    const previewPanel = document.getElementById('preview-panel');
    const resumenPanel = document.getElementById('resumen-panel');

    // Al hacer vista previa, llamamos al endpoint /montaje_offset/preview
    btnPreview.addEventListener('click', async () => {
      loader.style.display = 'block';
      previewPanel.innerHTML = '';
      resumenPanel.innerHTML = '';
      try {
        const fd = new FormData(form);
        const resp = await fetch('{{ url_for("routes.montaje_offset_preview") }}', {
          method: 'POST',
          body: fd
        });
        const data = await resp.json();
        if (!data.ok) throw new Error(data.error || 'No se pudo generar vista previa');

        // Imagen
        const img = document.createElement('img');
          img.src = data.preview_data;  // "data:image/*;base64,..."
        img.style.maxWidth = '100%';
        img.alt = 'Vista previa del montaje';
        previewPanel.appendChild(img);

        // Resumen (HTML seguro generado del servidor)
        if (data.resumen_html) {
          resumenPanel.innerHTML = data.resumen_html;
        }

        // (Opcional) habilita generación solamente luego de la vista previa:
        // btnGenerate.disabled = false;

      } catch (e) {
        alert(e.message);
      } finally {
        loader.style.display = 'none';
      }
    });

    // Reset: limpia panels
    btnReset.addEventListener('click', () => {
      previewPanel.innerHTML = '';
      resumenPanel.innerHTML = '';
      // (Opcional) volver a deshabilitar generar:
      // btnGenerate.disabled = false; // o true si querés forzar preview antes
    });
  </script>
</body>
</html>
