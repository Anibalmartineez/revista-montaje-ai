<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Montaje Offset Inteligente</title>
  <style>
    /* Solo oculta bloques avanzados cuando el formulario está en modo IA */
    #montaje-offset-form.ia-on .ia-advanced {
      display: none;
    }

    #montaje-offset-form.ia-on .ia-advanced *:disabled {
      opacity: .6;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>Montaje Offset Inteligente</h1>
  <div style="margin: 8px 0;">
    <a href="{{ url_for('editor_offset_visual') }}" class="btn btn-secondary" target="_blank">
      Editor visual IA (nuevo)
    </a>
  </div>
  <div class="modo-switch">
    <button type="button" id="btn-modo-std" class="btn active">Modo estándar</button>
    <button type="button" id="btn-modo-pro" class="btn">Modo super personalizado</button>
  </div>
  <div id="form-std">
  <form id="montaje-offset-form" method="POST" enctype="multipart/form-data">
    <input type="hidden" name="accion" id="accion" value="generar">
    <label>Subir de 1 a 5 archivos PDF:</label>
    <div id="archivos-container">
      <div class="archivo-row">
        <input type="file" name="archivos[]" accept=".pdf" required>
      </div>
    </div>
    <button type="button" id="add-archivo-btn">Agregar otro PDF</button>
    <div id="repeticiones-container"></div>
    <small>Puedes agregar varios PDFs usando el botón “Agregar otro PDF”.</small>
    <script>
      const archivosContainer = document.getElementById('archivos-container');
      const repeticionesContainer = document.getElementById('repeticiones-container');
      const addArchivoBtn = document.getElementById('add-archivo-btn');

      function agregarInputArchivo() {
        const row = document.createElement('div');
        row.className = 'archivo-row';
        row.innerHTML = '<input type="file" name="archivos[]" accept=".pdf">';
        archivosContainer.appendChild(row);
      }

      function renderRepeticiones() {
        const inputs = archivosContainer.querySelectorAll('input[name="archivos[]"]');
        const archivosSeleccionados = [];

        inputs.forEach((input) => {
          if (input.files && input.files[0]) {
            archivosSeleccionados.push(input.files[0]);
          }
        });

        repeticionesContainer.innerHTML = '';

        archivosSeleccionados.forEach((file, index) => {
          const div = document.createElement('div');
          div.innerHTML = `
        <label>${file.name} - Cantidad de repeticiones:</label>
        <input type="number" name="repeticiones_${index}" min="1" value="1" required>
        <input type="hidden" name="nombre_archivo_${index}" value="${file.name}">
        <br><br>
      `;
          repeticionesContainer.appendChild(div);
        });
      }

      archivosContainer.addEventListener('change', (event) => {
        if (event.target && event.target.name === 'archivos[]') {
          renderRepeticiones();
        }
      });

      addArchivoBtn.addEventListener('click', () => {
        agregarInputArchivo();
      });
    </script>
    <br><br>
    <label>Seleccionar tamaño de pliego:</label>
    <select name="pliego">
      <option value="640x880">640x880 mm</option>
      <option value="700x1000">700x1000 mm</option>
      <option value="personalizado">Personalizado</option>
    </select>
    <div id="pliego-personalizado" style="display:none;">
      <label>Ancho del pliego (mm):</label>
      <input type="number" name="ancho_pliego_custom" step="0.01">
      <label>Alto del pliego (mm):</label>
      <input type="number" name="alto_pliego_custom" step="0.01">
    </div>
    <br><br>
    <label>Separación doble corte (mm):</label>
    <input type="number" name="separacion" value="4" step="0.01">
    <br>
    <label>Espaciado horizontal (mm):</label>
    <input type="number" name="espaciado_horizontal" value="0" step="0.01">
    <br>
    <label>Espaciado vertical (mm):</label>
    <input type="number" name="espaciado_vertical" value="0" step="0.01">
    <br>
    <label>
      <input type="checkbox" name="cutmarks_por_forma">
      Añadir marcas de corte por forma (usa la misma longitud que el sangrado)
    </label>
    <br>
    <small>Si el sangrado efectivo es 0 mm, no se dibujarán marcas.</small>
    <br>
    <label>
      <input type="checkbox" name="export_area_util" checked>
      Exportar solo el área útil montada (recortar el pliego al contenido usado)
    </label>
    <br>
    <small>Incluye formas, sangrado y marcas activadas. No escala, solo recorta.</small>
    <div class="form-group">
      <label for="export_compat">Compatibilidad PDF (opcional)</label>
      <select id="export_compat" name="export_compat">
        <option value="">Ninguna (estándar)</option>
        <option value="pdfx1a">PDF/X-1a (CTP/Indesign)</option>
        <option value="adobe_compatible">Compatibilidad Adobe (Illustrator)</option>
      </select>
      <small class="help">
        PDF/X-1a: CMYK y transparencias aplanadas (ideal para CTP/Indesign al “Colocar”).<br>
        Compatibilidad Adobe: PDF 1.4 sin object streams; abre mejor en Illustrator.
      </small>
    </div>
    <br>
    <label>Margen izquierdo (mm):</label>
    <input type="number" name="margen_izq" value="10" step="0.01">
    <br>
    <label>Margen derecho (mm):</label>
    <input type="number" name="margen_der" value="10" step="0.01">
    <br>
    <label>Margen superior (mm):</label>
    <input type="number" name="margen_sup" value="10" step="0.01">
    <br>
    <label>Margen inferior (mm):</label>
    <input type="number" name="margen_inf" value="10" step="0.01">
    <br>

    <fieldset style="margin-top:10px;">
      <legend>Sangrado</legend>
      <label><input type="radio" name="modo_sangrado" value="original" checked> Usar sangrado original del archivo</label><br>
      <label><input type="radio" name="modo_sangrado" value="add"> Añadir sangrado de: <input type="number" name="sangrado_add" min="0" step="0.1" disabled> mm</label><br>
      <label><input type="radio" name="modo_sangrado" value="replace"> Reemplazar sangrado existente con: <input type="number" name="sangrado_replace" min="0" step="0.1" disabled> mm</label>
    </fieldset>

    <label><input type="checkbox" name="centrar" checked> Centrar montaje en pliego</label><br>
    <div style="margin-top:8px;">
      <input type="checkbox" id="modo_ia" name="modo_ia" value="1">
      <label for="modo_ia">Modo IA (recomendado)</label>
    </div>
    <section class="ia-advanced" style="margin-top:8px;">
      <label for="estrategia">Estrategia de montaje:</label>
      <select id="estrategia" name="estrategia">
        <option value="flujo">Flujo (auto)</option>
        <option value="grid">Grid (filas/columnas o celda fija)</option>
        <option value="maxrects">MaxRects (anidado eficiente)</option>
      </select>
    </section>

    <!-- Controles comunes: mantener márgenes, separaciones, etc. -->

    <!-- Grupo Flujo -->
    <div id="grupo-flujo" class="ia-advanced">
      <label><input type="checkbox" name="alinear_filas" checked title="Alinea por la altura mayor de cada fila"> Alinear por filas</label>
      <label><input type="checkbox" name="preferir_horizontal" title="Si hay rotación, prioriza ancho>alto"> Preferir orientación horizontal</label>
    </div>

    <!-- Grupo Grid -->
    <div id="grupo-grid" style="display:none;" class="ia-advanced">
      <div>
        <label>Filas (opcional): <input type="number" name="filas" min="0" step="1" value="0"></label>
        <label>Columnas (opcional): <input type="number" name="columnas" min="0" step="1" value="0"></label>
      </div>
      <div>
        <small>O usar celda fija (sin reescalar):</small><br>
        <label>Ancho celda (mm): <input type="number" name="celda_ancho" min="0" step="0.1" value="0"></label>
        <label>Alto celda (mm): <input type="number" name="celda_alto" min="0" step="0.1" value="0"></label>
      </div>
      <label><input type="checkbox" name="preferir_horizontal" title="Si hay rotación, prioriza ancho>alto"> Preferir orientación horizontal</label>
    </div>

    <!-- Grupo MaxRects -->
    <div id="grupo-maxrects" style="display:none;" class="ia-advanced">
      <small>Consejo: activar “Ordenar por tamaño” para mejor aprovechamiento.</small><br>
      <label><input type="checkbox" name="ordenar_tamano" checked title="Coloca primero piezas grandes para reducir huecos"> Ordenar por tamaño</label>
    </div>

    <details style="margin-top:12px;">
      <summary>Opciones avanzadas (Offset)</summary>
      <div style="margin-top:8px;">
        <label>Reserva pinza (mm): <input type="number" name="pinza_mm" min="0" step="0.1" value="0" title="Reserva en el borde de pinza (parte inferior del pliego en orientación de trabajo)"></label>
        <label>Reserva lateral (mm): <input type="number" name="lateral_mm" min="0" step="0.1" value="0" title="Reserva lateral para pinza/guía lateral"></label>
        <div style="margin-top:6px;">
          <label><input type="checkbox" name="marcas_registro"> Añadir marcas de registro</label>
          <label><input type="checkbox" name="marcas_corte"> Añadir marcas de corte</label>
        </div>
        <div style="margin-top:6px;">
          <label><input type="checkbox" name="debug_grilla"> Mostrar guías (debug)</label>
        </div>
      </div>
    </details>

    <br>
    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
      <button type="button" class="btn btn-secondary" id="btn-preview">Vista previa (150 dpi)</button>
      <button type="submit" class="btn btn-primary" id="btn-generar">Generar PDF</button>
      <button id="btn-reset" type="reset">Actualizar formulario</button>
      <button type="button" id="btn-manual-mode">Entrar a edición manual</button>
    </div>
  </form>

  {% if resultado and resultado.pdf_url %}
  <hr>
  <div class="resultado-final" style="margin-top:1rem;">
    <h3>PDF generado</h3>
    <a class="btn btn-success" href="{{ resultado.pdf_url }}" target="_blank" rel="noopener">Descargar PDF</a>
  </div>
  {% endif %}

  {% if layout_json_exists and modo_ia and ENABLE_POST_EDITOR %}
    <div class="post-editor" style="margin-top:1rem;">
      <a class="btn btn-primary" href="{{ url_for('routes.editor', id=job_id) }}">Editar montaje IA</a>
    </div>
  {% endif %}

  {% if preview_url %}
  <hr>
  <h3>Vista previa</h3>
  <div style="display:flex; gap:1rem; align-items:flex-start; flex-wrap:wrap;">
    <img src="{{ preview_url }}" alt="Vista previa montaje" style="max-width:100%; height:auto; border:1px solid #ddd; box-shadow:0 1px 3px rgba(0,0,0,.08)">
    {% if resumen_html %}
      <div style="min-width:280px; max-width:520px;">
        <h4>Resumen técnico</h4>
        <div class="resumen-html" style="font-size:.95rem; line-height:1.35" >
          {{ resumen_html|safe }}
        </div>
      </div>
    {% endif %}
  </div>
  {% endif %}

  <div id="manual-editor" style="display:none; margin-top:12px;">
    <div class="toolbar" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <button type="button" id="btn-manual-apply">Aplicar edición manual</button>
      <button type="button" id="btn-manual-generate">Generar PDF (manual)</button>
      <label>Grid (mm): <input id="grid_mm" type="number" step="0.5" value="1"></label>
      <label><input type="checkbox" id="snap_on" checked> Snap</label>
      <label><input type="checkbox" id="snap_obj" checked> Snap a objetos</label>
      <label><input type="checkbox" id="validar_solapes"> Validar solapes</label>
      <button type="button" id="fit_width">Ajustar ancho</button>
      <button type="button" id="fit_page">Ajustar página</button>
      <span>Zoom: <input id="zoom_range" type="range" min="10" max="200" value="100"> <span id="zoom_label">100%</span></span>
      <span id="cursor_mm"></span>
    </div>
    <div class="stage" id="manual-stage" style="position:relative; overflow:auto; max-width:100%; max-height:70vh; border:1px solid #ddd; background:#fafafa;">
      <div id="viewport" style="position:relative; transform-origin: top left;">
        <img id="preview_img" src="{{ preview_url or '' }}" alt="preview" style="display:block; width:100%; height:auto;" />
        <canvas id="overlay" tabindex="0" width="0" height="0" style="position:absolute; left:0; top:0; pointer-events:auto;"></canvas>
      </div>
    </div>
    <input type="hidden" id="manual_json" name="manual_json">
    <div id="manual-warnings" style="color:#c00; min-height:1em;"></div>
  </div>

  <script>
    document.querySelector('select[name="pliego"]').addEventListener('change', function() {
      document.getElementById('pliego-personalizado').style.display =
        this.value === 'personalizado' ? 'block' : 'none';
    });

    const formStd = document.getElementById('montaje-offset-form');
    const selE = document.querySelector('select[name="estrategia"]');
    const gFlujo = document.getElementById('grupo-flujo');
    const gGrid = document.getElementById('grupo-grid');
    const gMR = document.getElementById('grupo-maxrects');
    const celdaAncho = document.querySelector('input[name="celda_ancho"]');
    const celdaAlto = document.querySelector('input[name="celda_alto"]');
    const filas = document.querySelector('input[name="filas"]');
    const columnas = document.querySelector('input[name="columnas"]');
    const radiosSangrado = document.querySelectorAll('input[name="modo_sangrado"]');

    function actualizarSangradoInputs() {
      const modo = document.querySelector('input[name="modo_sangrado"]:checked').value;
      document.querySelector('input[name="sangrado_add"]').disabled = modo !== 'add';
      document.querySelector('input[name="sangrado_replace"]').disabled = modo !== 'replace';
    }
    radiosSangrado.forEach(r => r.addEventListener('change', actualizarSangradoInputs));
    actualizarSangradoInputs();

    function setGroupState(group, active) {
      if (!group) return;
      group.style.display = active ? 'block' : 'none';
      group.querySelectorAll('input, select, textarea, button').forEach(inp => inp.disabled = !active);
    }

    function toggleByStrategy() {
      if (!selE) return;
      if (formStd?.classList.contains('ia-on')) {
        setGroupState(gFlujo, false);
        setGroupState(gGrid, false);
        setGroupState(gMR, false);
        return;
      }
      const v = selE.value;
      setGroupState(gFlujo, v === 'flujo');
      setGroupState(gGrid, v === 'grid');
      setGroupState(gMR, v === 'maxrects');
      if (v === 'grid') toggleGridInputs();
    }

    function toggleGridInputs() {
      if (!filas || !columnas) return;
      const usarCelda = (parseFloat(celdaAncho?.value || '0') > 0) || (parseFloat(celdaAlto?.value || '0') > 0);
      filas.disabled = usarCelda;
      columnas.disabled = usarCelda;
    }

    selE?.addEventListener('change', toggleByStrategy);
    celdaAncho?.addEventListener('input', toggleGridInputs);
    celdaAlto?.addEventListener('input', toggleGridInputs);
    toggleByStrategy();
    toggleGridInputs();

    window.toggleByStrategy = toggleByStrategy;
    window.toggleGridInputs = toggleGridInputs;

    (function(){
      const frm = document.getElementById('montaje-offset-form');
      const accion = document.getElementById('accion');
      const btnPrev = document.getElementById('btn-preview');
      const btnGen  = document.getElementById('btn-generar');
      if (btnPrev) {
        btnPrev.addEventListener('click', function(){
          accion.value = 'preview';
          frm.submit();
        });
      }
      if (btnGen) {
        btnGen.addEventListener('click', function(){
          accion.value = 'generar';
        });
      }
    })();
  </script>
  </div>

  <div id="form-pro" style="display:none;">
    <form id="pro-form" method="post" enctype="multipart/form-data">
      <input type="hidden" name="mode" value="pro">

      <label>Subir de 1 a 5 archivos PDF:</label>
      <input type="file" name="pro_files" id="pro_files" multiple accept="application/pdf">

      <div class="fila">
        <label>Tamaño de pliego:</label>
        <select name="pro_pliego">
          <option value="640x880">640x880 mm</option>
          <option value="700x1000">700x1000 mm</option>
          <option value="personalizado">Personalizado</option>
        </select>
      </div>
      <div id="pro-pliego-personalizado" style="display:none;">
        <label>Ancho del pliego (mm):</label>
        <input type="number" name="pro_ancho_pliego_custom" step="0.01">
        <label>Alto del pliego (mm):</label>
        <input type="number" name="pro_alto_pliego_custom" step="0.01">
      </div>

      <div class="fila">
        <label>Margen izquierdo (mm):</label>
        <input type="number" step="0.1" name="pro_margen_izq" value="10">
        <label>Margen derecho (mm):</label>
        <input type="number" step="0.1" name="pro_margen_der" value="10">
        <label>Margen superior (mm):</label>
        <input type="number" step="0.1" name="pro_margen_sup" value="10">
        <label>Margen inferior (mm):</label>
        <input type="number" step="0.1" name="pro_margen_inf" value="10">
      </div>

      <div class="fila">
        <label>Separación doble corte (mm):</label>
        <input type="number" step="0.1" name="pro_separacion" value="4">
        <label>Espaciado horizontal (mm):</label>
        <input type="number" step="0.1" name="pro_espaciado_horizontal" value="0">
        <label>Espaciado vertical (mm):</label>
        <input type="number" step="0.1" name="pro_espaciado_vertical" value="0">
      </div>

      <label><input type="checkbox" name="pro_cutmarks"> Añadir marcas de corte por forma</label><br>
      <label><input type="checkbox" name="pro_export_area_util" checked> Exportar solo el área útil montada</label>
      <div class="form-group">
        <label for="pro_export_compat">Compatibilidad PDF (opcional)</label>
        <select id="pro_export_compat" name="export_compat">
          <option value="">Ninguna (estándar)</option>
          <option value="pdfx1a">PDF/X-1a (CTP/Indesign)</option>
          <option value="adobe_compatible">Compatibilidad Adobe (Illustrator)</option>
        </select>
        <small class="help">
          PDF/X-1a: CMYK y transparencias aplanadas (ideal para CTP/Indesign al “Colocar”).<br>
          Compatibilidad Adobe: PDF 1.4 sin object streams; abre mejor en Illustrator.
        </small>
      </div>

      <hr>
      <div id="pro-archivos-config"></div>

      <div class="acciones">
        <button type="submit" class="btn">Vista previa</button>
        <button type="submit" name="pro_generar_pdf" value="1" class="btn">Generar PDF</button>
      </div>
    </form>
  </div>

  <script>
  (function(){
    const filesInput = document.getElementById('pro_files');
    const holder = document.getElementById('pro-archivos-config');
    const tpl = (name, i, label, html) => `
    <div class="pro-row">
      <h4>${label}</h4>
      <div class="grid">
        <label>Repeticiones (por pliego): <input name="pro_reps[]" type="number" min="0" placeholder="auto"></label>
        <label>Rotar 90°: <input name="pro_rotate[]" type="checkbox"></label>
        <label>Sangrado (mm): <input name="pro_bleed_mm[]" type="number" step="0.1" placeholder="usar global"></label>
        <label>Marcas de corte: <input name="pro_cutmarks[]" type="checkbox"></label>
        <label>Prioridad: <input name="pro_priority[]" type="number" value="${i+1}" min="1"></label>
        <label>Alineación: 
          <select name="pro_align[]">
            <option value="left">Izquierda</option>
            <option value="center" selected>Centro</option>
            <option value="right">Derecha</option>
          </select>
        </label>
      </div>
      <div class="medidas" id="pro_medidas_${i}"></div>
      <input type="hidden" name="pro_filename[]" value="">
    </div>`;
    filesInput?.addEventListener('change', () => {
      holder.innerHTML = '';
      [...filesInput.files].forEach((f,i)=>{
        const div = document.createElement('div');
        div.innerHTML = tpl('pro', i, `Archivo ${i+1}: ${f.name}`, '');
        div.querySelector('input[name="pro_filename[]"]').value = f.name;
        holder.appendChild(div);
      });
    });

    // Conmutador de modos
    const btnStd = document.getElementById('btn-modo-std');
    const btnPro = document.getElementById('btn-modo-pro');
    const std = document.getElementById('form-std');
    const pro = document.getElementById('form-pro');
    btnStd?.addEventListener('click', ()=>{ std.style.display='block'; pro.style.display='none'; btnStd.classList.add('active'); btnPro.classList.remove('active'); });
    btnPro?.addEventListener('click', ()=>{ std.style.display='none'; pro.style.display='block'; btnPro.classList.add('active'); btnStd.classList.remove('active'); });

    const proPliego = document.querySelector('select[name="pro_pliego"]');
    proPliego?.addEventListener('change', function(){
      document.getElementById('pro-pliego-personalizado').style.display = this.value === 'personalizado' ? 'block' : 'none';
    });
  })();
  </script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('#montaje-offset-form');
    const iaToggle = document.querySelector('#modo_ia');

    const setIA = (on) => {
      if (!form) return;
      form.classList.toggle('ia-on', !!on);

      const advInputs = form.querySelectorAll('.ia-advanced input, .ia-advanced select, .ia-advanced textarea, .ia-advanced button');
      advInputs.forEach(el => { el.disabled = !!on; });

      if (typeof window.toggleByStrategy === 'function') {
        window.toggleByStrategy();
      }
      if (!on && typeof window.toggleGridInputs === 'function') {
        window.toggleGridInputs();
      }
    };

    setIA(iaToggle?.checked ?? false);

    iaToggle?.addEventListener('change', (e) => setIA(e.target.checked));

    try {
      const params = new URLSearchParams(window.location.search);
      if (params.get('debug_ia') === '1') {
        console.warn('[IA DEBUG] iaToggle:', iaToggle?.checked, 'form has ia-on?', form?.classList.contains('ia-on'));
        document.querySelectorAll('.ia-advanced').forEach((sec, i) => {
          sec.style.outline = '1px dashed #999';
          sec.dataset.debug = 'ia-advanced-' + (i+1);
          console.warn('[IA DEBUG] ia-advanced section', i+1, sec);
        });
      }
    } catch(e) {}
  });
  </script>
  {% if preview_url %}
  <script>
    window.__sheetMm    = {{ sheet_mm|tojson|safe }};
    window.__positions  = {{ positions|tojson|safe }};
    window.__sangradoMm = {{ sangrado_mm|default(0) }};
    window.__previewUrl = "{{ preview_url }}";
    window.__manualFiles = {{ files_list|tojson|safe }};   // lista de rutas de PDFs
  </script>
  {% endif %}
  <script src="{{ url_for('static', filename='js/manual_editor.js') }}"></script>
  <script src="{{ url_for('static', filename='js/manual_editor_dom.js') }}"></script>
  {% if preview_url %}
  <script>
    if (window.manualEditorLoad) {
      window.manualEditorLoad({
        sheet_mm: window.__sheetMm,
        positions: window.__positions,
        sangrado_mm: window.__sangradoMm,
        preview_url: window.__previewUrl
      });
    }
  </script>
  {% endif %}
</body>
</html>
