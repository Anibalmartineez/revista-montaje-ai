<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resultado diagnóstico flexo</title>
  <style>
    #contenedor-imagen {
      position: relative;
      display: inline-block;
    }
    .imagen-analizada {
      width: 100%;
      max-width: 800px;
      display: block;
      margin: auto;
      position: relative;
    }
    .botones {
      text-align: center;
      margin-top: 20px;
    }
    .botones .btn {
      display: inline-block;
      padding: 10px 20px;
      background: #0056b3;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
    }
    #tabla-riesgos table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #tabla-riesgos th, #tabla-riesgos td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #tabla-riesgos th {
      background: #f0f0f0;
    }
    #overlay-markers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
    .warning-marker {
      position: absolute;
      color: #000;
      font-size: 12px;
      text-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
      pointer-events: none;
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid red;
      border-radius: 4px;
      padding: 3px;
      white-space: nowrap;
      box-shadow: 0 0 2px red;
    }
    .warning-marker::before {
      content: "⚠️ ";
    }
    .warning-marker.highlighted {
      outline: 3px solid red;
      box-shadow: 0 0 4px red;
    }
    #lista-advertencias {
      list-style: none;
      padding-left: 0;
      max-width: 800px;
      margin: 20px auto;
    }
    #lista-advertencias li {
      cursor: pointer;
      margin: 5px 0;
    }
    #lista-advertencias .cuadro-alerta {
      vertical-align: middle;
    }

    .cuadro-alerta {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 3px;
      margin-right: 4px;
    }

    .tipo-texto {
      background-color: red;
    }

    .tipo-trama {
      background-color: purple;
    }

    .tipo-resolucion {
      background-color: orange;
    }

    .tipo-overprint {
      background-color: blue;
    }

    .tipo-borde {
      background-color: darkgreen;
    }
  </style>
</head>
<body>
  <div id="contenedor-imagen" style="position: relative;">
    <img src="{{ url_for('static', filename=imagen_path_web) }}" id="imagen-diagnostico" class="imagen-analizada" />
    <div id="overlay-markers"></div>
  </div>
  <ul id="lista-advertencias">
    {% set tipo_clases = {
      'texto_pequeno': 'tipo-texto',
      'trama_debil': 'tipo-trama',
      'imagen_baja': 'tipo-resolucion',
      'overprint': 'tipo-overprint',
      'sin_sangrado': 'tipo-borde'
    } %}
    {% for adv in advertencias_iconos %}
      <li data-idx="{{ loop.index0 }}">
        <span class="cuadro-alerta {{ tipo_clases.get(adv.tipo, '') }}"></span>{{ (adv.mensaje | default('', true) | trim) or 'Advertencia sin descripción detallada.' }}
      </li>
    {% endfor %}
  </ul>
  <script>
    const advertencias = {{ advertencias_iconos|tojson }};
    const overlay = document.getElementById("overlay-markers");
    const imagen = document.getElementById("imagen-diagnostico");
    const tipoClase = {
      'texto_pequeno': 'tipo-texto',
      'trama_debil': 'tipo-trama',
      'imagen_baja': 'tipo-resolucion',
      'overprint': 'tipo-overprint',
      'sin_sangrado': 'tipo-borde'
    };

    function evitarSuperposicion(icon) {
      let superpuesto = true;
      while (superpuesto) {
        superpuesto = false;
        const rect = icon.getBoundingClientRect();
        overlay.querySelectorAll('.warning-marker').forEach(other => {
          if (other === icon) return;
          const orect = other.getBoundingClientRect();
          if (rect.left < orect.right && rect.right > orect.left && rect.top < orect.bottom && rect.bottom > orect.top) {
            const nuevoTop = parseFloat(icon.style.top) + orect.height + 2;
            icon.style.top = nuevoTop + 'px';
            superpuesto = true;
          }
        });
      }
    }

    function dibujarIconos() {
      const scaleX = imagen.clientWidth / imagen.naturalWidth;
      const scaleY = imagen.clientHeight / imagen.naturalHeight;
      advertencias.forEach((item, idx) => {
        const icon = document.createElement('span');
        icon.className = 'warning-marker ' + (tipoClase[item.tipo] || '');
        const texto = (item.mensaje && item.mensaje.trim()) ? item.mensaje.trim() : 'Advertencia sin descripción detallada.';
        icon.textContent = texto;
        icon.style.left = (item.pos[0] * scaleX) + 'px';
        icon.style.top = (item.pos[1] * scaleY) + 'px';
        icon.dataset.idx = idx;
        overlay.appendChild(icon);
        evitarSuperposicion(icon);
      });

      document.querySelectorAll('#lista-advertencias li').forEach(li => {
        li.addEventListener('click', () => {
          const idx = li.getAttribute('data-idx');
          overlay.querySelectorAll('.warning-marker').forEach(m => m.classList.remove('highlighted'));
          const icon = overlay.querySelector(`.warning-marker[data-idx="${idx}"]`);
          if (icon) {
            icon.classList.add('highlighted');
          }
        });
      });
    }

    if (imagen.complete) {
      dibujarIconos();
    } else {
      imagen.onload = dibujarIconos;
    }
  </script>
  <div id="resumen-diagnostico">{{ resumen|safe }}</div>
  {{ tabla_riesgos|safe }}
  <div class="botones">
    <a href="{{ url_for('static', filename=imagen_iconos_web) }}" class="btn" download>⬇ Descargar imagen con advertencias</a>
    <a href="{{ url_for('routes.revision_flexo') }}" class="btn">⬅ Volver a revisar otro diseño</a>
  </div>
</body>
</html>
