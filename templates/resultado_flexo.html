<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Resultado diagn√≥stico flexo</title>
  <style>
    #contenedor-imagen {
      position: relative;
      display: inline-block;
    }
    .imagen-analizada {
      width: 100%;
      max-width: 800px;
      display: block;
      margin: auto;
      position: relative;
    }
    .botones {
      text-align: center;
      margin-top: 20px;
    }
    .botones .btn {
      display: inline-block;
      padding: 10px 20px;
      background: #0056b3;
      color: #fff;
      text-decoration: none;
      border-radius: 4px;
    }
    #tabla-riesgos table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #tabla-riesgos th, #tabla-riesgos td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    #tabla-riesgos th {
      background: #f0f0f0;
    }
    #overlay-markers {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    .warning-box {
      position: absolute;
      border: 2px solid red;
      background: rgba(255, 0, 0, 0.1);
      pointer-events: none;
    }

    .warning-icon {
      position: absolute;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      color: #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      pointer-events: auto;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }

    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px 8px;
      border-radius: 4px;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: none;
      pointer-events: auto;
      z-index: 10000;
    }

    .tooltip.visible {
      display: block;
    }

    .warning-box.highlighted {
      box-shadow: 0 0 0 3px red;
    }
    #lista-advertencias {
      list-style: none;
      padding-left: 0;
      max-width: 800px;
      margin: 20px auto;
    }
    #lista-advertencias li {
      cursor: pointer;
      margin: 5px 0;
    }
    #lista-advertencias .cuadro-alerta {
      vertical-align: middle;
    }

    .cuadro-alerta {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 3px;
      margin-right: 4px;
    }

    .tipo-texto { background-color: red; }
    .tipo-trama { background-color: purple; }
    .tipo-resolucion { background-color: orange; }
    .tipo-overprint { background-color: blue; }
    .tipo-borde { background-color: darkgreen; }

    .warning-box.tipo-texto { border-color: red; background: rgba(255,0,0,0.1); }
    .warning-box.tipo-trama { border-color: purple; background: rgba(128,0,128,0.1); }
    .warning-box.tipo-resolucion { border-color: orange; background: rgba(255,165,0,0.1); }
    .warning-box.tipo-overprint { border-color: blue; background: rgba(0,0,255,0.1); }
    .warning-box.tipo-borde { border-color: darkgreen; background: rgba(0,100,0,0.1); }

    .warning-icon.tipo-texto { background: red; }
    .warning-icon.tipo-trama { background: purple; }
    .warning-icon.tipo-resolucion { background: orange; }
    .warning-icon.tipo-overprint { background: blue; }
    .warning-icon.tipo-borde { background: darkgreen; }

    #datos-basicos {
      max-width: 980px;
      margin: 30px auto 0;
      background: #f6fbff;
      border-radius: 12px;
      padding: 20px 24px;
      box-shadow: inset 0 0 0 1px rgba(8, 48, 90, 0.08);
      color: #0b1f36;
    }
    #datos-basicos .datos-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }
    #datos-basicos .datos-col {
      flex: 1 1 260px;
    }
    #datos-basicos p {
      margin: 0.35rem 0;
    }
    #datos-basicos ul.datos-cobertura {
      list-style: none;
      padding: 0;
      margin: 0.5rem 0 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.25rem 0.75rem;
    }
    #datos-basicos ul.datos-cobertura li {
      font-size: 0.9rem;
      color: #1b3a57;
    }

    #simulacion-avanzada {
      margin-top: 40px;
      background: #f1faff;
      padding: 24px;
      border-radius: 12px;
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
      min-height: 320px;
    }
    #simulacion-avanzada h3 {
      text-align: center;
      margin-bottom: 0.5rem;
    }
    #simulacion-avanzada p.sim-desc {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #3d566e;
    }
    .sim-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
    }
    .sim-controls {
      flex: 1 1 260px;
    }
    .sim-controls label {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-bottom: 1rem;
      font-weight: 600;
      color: #1b3a57;
    }
    .sim-controls input[type="range"] {
      width: 100%;
    }
    .sim-controls span.valor {
      font-weight: 400;
      color: #0c2238;
      font-size: 0.9rem;
    }
    .sim-metrics {
      flex: 1 1 280px;
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 12px 26px rgba(8, 48, 90, 0.12);
    }
    .riesgo-badge {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      padding: 0.55rem 0.9rem;
      border-radius: 999px;
      font-weight: 600;
      margin-bottom: 1rem;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .riesgo-verde { background: #d4f7d1; color: #104911; }
    .riesgo-amarillo { background: #fff3c4; color: #6b4805; }
    .riesgo-rojo { background: #ffd6d2; color: #8c1f16; }
    .metricas-principales {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .metricas-principales li {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      border-bottom: 1px dashed #d4e4f2;
      padding-bottom: 0.75rem;
    }
    .metricas-principales li:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .metricas-principales .titulo {
      font-size: 0.85rem;
      color: #3b4c63;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .metricas-principales .valor {
      font-size: 1.2rem;
      font-weight: 700;
      color: #0b1f36;
    }
    .metricas-principales .detalle {
      font-size: 0.8rem;
      color: #526377;
    }
    .coverage-list {
      list-style: none;
      padding: 0;
      margin: 0.75rem 0 0;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.35rem 0.75rem;
      font-size: 0.85rem;
      color: #1b3a57;
    }
    .riesgo-detalle {
      list-style: disc;
      margin: 1rem 0;
      padding-left: 1.5rem;
      color: #27374d;
    }
    #sim-container {
      min-height: 280px;
      margin-top: 1rem;
    }
    #sim-canvas {
      width: 100%;
      height: auto;
      background: #eef7ff;
      display: block;
      min-width: 320px;
      min-height: 200px;
      border-radius: 8px;
      box-shadow: inset 0 0 0 1px rgba(8, 48, 90, 0.08);
    }
    .sim-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 1rem;
      justify-content: flex-end;
    }
    .sim-actions .btn {
      flex: 0 0 auto;
    }
    @media (max-width: 768px) {
      .sim-grid { flex-direction: column; }
      .sim-actions { justify-content: center; }
    }
  </style>
</head>
<body>
  {% set diag_img_static = url_for('static', filename=diag_img_web) if diag_img_web else '' %}
  {% set sim_canvas_base = diag_img_static or (url_for('static', filename=sim_base_img) if sim_base_img else '') %}
  <div id="contenedor-imagen" style="position: relative;">
    <img src="{{ url_for('static', filename=imagen_path_web) }}" id="imagen-diagnostico" class="imagen-analizada" />
    <div id="overlay-markers"></div>
    <div id="tooltip" class="tooltip"></div>
  </div>
  {% if pdf_path_web %}
  <div style="text-align:center;margin-top:20px;">
    <object data="{{ url_for('static', filename=pdf_path_web) }}" type="application/pdf" width="100%" height="600px">
      <p>Tu navegador no puede mostrar PDFs. <a href="{{ url_for('static', filename=pdf_path_web) }}">Descargar PDF</a>.</p>
    </object>
  </div>
  {% endif %}
  <ul id="lista-advertencias">
    {% set tipo_clases = {
      'texto_pequeno': 'tipo-texto',
      'trama_debil': 'tipo-trama',
      'imagen_baja': 'tipo-resolucion',
      'overprint': 'tipo-overprint',
      'sin_sangrado': 'tipo-borde'
    } %}
    {% for adv in advertencias_iconos %}
      <li data-idx="{{ loop.index0 }}">
        <span class="cuadro-alerta {{ tipo_clases.get(adv.tipo, '') }}"></span>{{ (adv.descripcion | default('', true) | trim) or (adv.mensaje | default('', true) | trim) or 'Advertencia sin descripci√≥n detallada.' }}
      </li>
    {% endfor %}
  </ul>
  <script>
    const advertencias = {{ advertencias_iconos|tojson }};
    window.advertencias = advertencias;
    const overlay = document.getElementById('overlay-markers');
    const imagen = document.getElementById('imagen-diagnostico');
    const tooltip = document.getElementById('tooltip');
    const tipoClase = {
      'texto_pequeno': 'tipo-texto',
      'trama_debil': 'tipo-trama',
      'imagen_baja': 'tipo-resolucion',
      'overprint': 'tipo-overprint',
      'sin_sangrado': 'tipo-borde'
    };

    const iconos = {
      'texto_pequeno': 'T',
      'trama_debil': '#',
      'imagen_baja': 'üñºÔ∏è',
      'overprint': 'O',
      'sin_sangrado': '‚õî'
    };

    const nombresTipo = {
      'texto_pequeno': 'Texto peque√±o',
      'trama_debil': 'Trama d√©bil',
      'imagen_baja': 'Imagen de baja resoluci√≥n',
      'overprint': 'Sobreimpresi√≥n',
      'sin_sangrado': 'Sin sangrado'
    };

    function evitarSuperposicion(icon) {
      let superpuesto = true;
      while (superpuesto) {
        superpuesto = false;
        const rect = icon.getBoundingClientRect();
        overlay.querySelectorAll('.warning-icon').forEach(other => {
          if (other === icon) return;
          const orect = other.getBoundingClientRect();
          if (rect.left < orect.right && rect.right > orect.left && rect.top < orect.bottom && rect.bottom > orect.top) {
            const nuevoTop = parseFloat(icon.style.top) + orect.height + 2;
            icon.style.top = nuevoTop + 'px';
            superpuesto = true;
          }
        });
      }
    }

    function dibujarIconos() {
      const scaleX = imagen.clientWidth / imagen.naturalWidth;
      const scaleY = imagen.clientHeight / imagen.naturalHeight;
      advertencias.forEach((item, idx) => {
        const x0 = item.bbox ? item.bbox[0] * scaleX : item.pos[0] * scaleX;
        const y0 = item.bbox ? item.bbox[1] * scaleY : item.pos[1] * scaleY;
        const ancho = item.bbox ? (item.bbox[2] - item.bbox[0]) * scaleX : 20;
        const alto = item.bbox ? (item.bbox[3] - item.bbox[1]) * scaleY : 20;

        const box = document.createElement('div');
        box.className = 'warning-box ' + (tipoClase[item.tipo] || '');
        box.style.left = x0 + 'px';
        box.style.top = y0 + 'px';
        box.style.width = ancho + 'px';
        box.style.height = alto + 'px';
        box.dataset.idx = idx;
        overlay.appendChild(box);

        const icon = document.createElement('span');
        icon.className = 'warning-icon advertencia-marcador ' + (tipoClase[item.tipo] || '');
        icon.innerHTML = iconos[item.tipo] || '‚ö†Ô∏è';
        icon.style.left = x0 - 10 + 'px';
        icon.style.top = y0 - 10 + 'px';
        icon.dataset.idx = idx;
        overlay.appendChild(icon);

        const descripcion =
          (item.descripcion && item.descripcion.trim()) ? item.descripcion.trim() :
          (item.mensaje && item.mensaje.trim()) ? item.mensaje.trim() :
          'Advertencia sin descripci√≥n detallada.';

        const nombre = nombresTipo[item.tipo] || item.tipo || 'Sin tipo';
        icon.dataset.tipo = nombre;
        icon.dataset.descripcion = descripcion || 'Sin descripci√≥n';

        icon.addEventListener('click', ev => {
          ev.stopPropagation();
          const tipo = icon.dataset.tipo || 'Advertencia';
          const desc = icon.dataset.descripcion || 'Sin descripci√≥n t√©cnica.';
          tooltip.innerHTML = `<button id="cerrar-tooltip">‚ùå</button><strong>${tipo}</strong><br><p>${desc}</p>`;
          tooltip.style.top = icon.style.top;
          tooltip.style.left = icon.style.left;
          tooltip.classList.add('visible');
          const btnCerrar = document.getElementById('cerrar-tooltip');
          btnCerrar.addEventListener('click', (e) => {
            e.stopPropagation();
            tooltip.classList.remove('visible');
          });
        });

        evitarSuperposicion(icon);
      });

      document.addEventListener('click', () => {
        tooltip.classList.remove('visible');
      });

      tooltip.addEventListener('click', ev => {
        ev.stopPropagation();
      });

      document.querySelectorAll('#lista-advertencias li').forEach(li => {
        li.addEventListener('click', () => {
          const idx = li.getAttribute('data-idx');
          overlay.querySelectorAll('.warning-box').forEach(m => m.classList.remove('highlighted'));
          const box = overlay.querySelector(`.warning-box[data-idx="${idx}"]`);
          if (box) {
            box.classList.add('highlighted');
          }
        });
      });
    }

    if (imagen.complete) {
      dibujarIconos();
    } else {
      imagen.onload = dibujarIconos;
    }
  </script>
  {% set diag = diagnostico_json or {} %}
  {% set lpi_diag = diag.get('anilox_lpi') if diag.get('anilox_lpi') is not none else diag.get('lpi') %}
  {% set bcm_diag = diag.get('anilox_bcm') if diag.get('anilox_bcm') is not none else diag.get('bcm') %}
  {% set paso_diag = diag.get('paso_del_cilindro') if diag.get('paso_del_cilindro') is not none else (diag.get('paso_cilindro') or diag.get('paso')) %}
  {% set vel_diag = diag.get('velocidad_impresion') if diag.get('velocidad_impresion') is not none else (diag.get('velocidad') if diag.get('velocidad') is not none else diag.get('velocidad_estimada')) %}
  {% set lpi_val = lpi_diag if lpi_diag is not none else 120 %}
  {% set bcm_val = bcm_diag if bcm_diag is not none else 2.0 %}
  {% set paso_val = paso_diag if paso_diag is not none else 330 %}
  {% set vel_val = vel_diag if vel_diag is not none else 150 %}
  {% set lpi_display = '%g' % lpi_val %}
  {% set bcm_display = '%g' % bcm_val %}
  {% set paso_display = '%g' % paso_val %}
  {% set vel_display = '%g' % vel_val %}
  {% set diag_stats = indicadores_advertencias or diag.get('indicadores_advertencias') or {} %}
  {% set diag_cob_letras = diag.get('cobertura') or {} %}
  {% set diag_cob_nombres = diag.get('cobertura_por_canal') or {} %}
  {% set tac_diag = diag.get('tac_total') if diag.get('tac_total') is not none else diag.get('cobertura_estimada') %}
  {% set ancho_mm_val = diag.get('ancho_mm') %}
  {% set ancho_m_val = diag.get('ancho_util_m') if diag.get('ancho_util_m') is not none else ((ancho_mm_val or 0) / 1000 if ancho_mm_val else none) %}
  {% set advertencias_txt = advertencias_resumen or diag.get('advertencias_resumen') %}
  <section id="datos-basicos">
    <div class="datos-grid">
      <div class="datos-col">
        <p><strong>Archivo PDF:</strong> {{ diag.get('archivo', 'diagnostico.pdf') }}</p>
        <p><strong>Material de impresi√≥n:</strong> {{ diag.get('material', '(calculado en diagn√≥stico)') }}</p>
        <p><strong>Anilox LPI (diagn√≥stico):</strong> {{ lpi_display }}{% if lpi_diag is none %} (estimado){% endif %}</p>
        <p><strong>BCM del anilox:</strong> {{ bcm_display }}{% if bcm_diag is none %} (estimado){% endif %}</p>
        <p><strong>Velocidad de c√°lculo:</strong> {{ vel_display }} m/min{% if vel_diag is none %} (estimada){% endif %}</p>
        <p><strong>Paso del cilindro:</strong> {{ paso_display }} mm</p>
        {% if ancho_mm_val %}
        <p><strong>Ancho √∫til estimado:</strong> {{ '%0.1f' % ancho_mm_val }} mm ({{ '%0.2f' % (ancho_m_val or 0) }} m)</p>
        {% endif %}
      </div>
      <div class="datos-col">
        <p><strong>TAC promedio detectado:</strong> {{ tac_diag|default(0, true)|round(2) }} %</p>
        <p><strong>Cobertura CMYK:</strong></p>
        {% set nombres_cmyk = {'C': 'Cian', 'M': 'Magenta', 'Y': 'Amarillo', 'K': 'Negro'} %}
        <ul class="datos-cobertura">
          {% for canal in ['C', 'M', 'Y', 'K'] %}
            {% set valor = diag_cob_letras.get(canal) if diag_cob_letras else diag_cob_nombres.get(nombres_cmyk[canal]) %}
            <li><strong>{{ nombres_cmyk[canal] }}:</strong> {{ valor|default(0, true)|round(2) }} %</li>
          {% endfor %}
        </ul>
        {% if advertencias_txt %}
          <p><strong>Advertencias:</strong> {{ advertencias_txt }}</p>
        {% endif %}
        {% if diag_stats.get('total') %}
          <p><strong>Total de advertencias:</strong> {{ diag_stats.get('total') }}</p>
        {% endif %}
      </div>
    </div>
  </section>
  <div id="resumen-diagnostico">{{ resumen|safe }}</div>
  {{ tabla_riesgos|safe }}

  <section id="simulacion-avanzada">
    <h3>‚öôÔ∏è Simulaci√≥n Avanzada de Impresi√≥n</h3>
    <p class="sim-desc">Ajust√° los par√°metros de m√°quina para predecir transmisi√≥n de tinta y riesgos reales detectados en el PDF.</p>
    <div class="sim-grid">
      <div class="sim-controls">
        <label>
          <span>Lineatura del anilox (LPI)</span>
          <input type="range" id="lpi" name="lpi" min="80" max="600" value="{{ lpi_display }}">
          <span id="lpi-val" class="valor">{{ lpi_display }} lpi</span>
        </label>
        <label>
          <span>BCM del anilox (cm¬≥/m¬≤)</span>
          <input type="range" id="bcm" name="bcm" min="1" max="15" step="0.1" value="{{ bcm_display }}">
          <span id="bcm-val" class="valor">{{ bcm_display }} cm¬≥/m¬≤</span>
        </label>
        <label>
          <span>Paso del cilindro (mm)</span>
          <input type="range" id="paso" name="paso" min="100" max="1000" value="{{ paso_display }}">
          <span id="paso-val" class="valor">{{ paso_display }} mm</span>
        </label>
        <label>
          <span>Velocidad de impresi√≥n (m/min)</span>
          <input type="range" id="vel" name="vel" min="50" max="500" value="{{ vel_display }}">
          <span id="vel-val" class="valor">{{ vel_display }} m/min</span>
        </label>
        {% set cob_in = tac_diag %}
        <label>
          <span>TAC objetivo para la simulaci√≥n (%)</span>
          <input type="range" id="cov" name="cov" min="0" max="400" step="0.5" value="{{ cob_in if cob_in is not none else 200 }}">
          <span id="cov-val" class="valor">{{ (cob_in if cob_in is not none else 200)|round(1) }} %</span>
        </label>
      </div>
      <div class="sim-metrics">
        <div id="riesgo-global" class="riesgo-badge riesgo-verde">
          <span class="riesgo-etiqueta">Riesgo global</span>
          <strong id="riesgo-valor">Verde</strong>
        </div>
        <ul class="metricas-principales">
          <li>
            <span class="titulo">Transmisi√≥n de tinta estimada</span>
            <span id="metric-ml" class="valor">--</span>
            <small id="metric-ml-detalle" class="detalle"></small>
          </li>
          <li>
            <span class="titulo">TAC del archivo</span>
            <span id="metric-tac" class="valor">--</span>
            <small id="metric-tac-limite" class="detalle"></small>
          </li>
          <li>
            <span class="titulo">Tramas en altas luces</span>
            <span id="metric-trama" class="valor">--</span>
          </li>
          <li>
            <span class="titulo">Sobreimpresi√≥n</span>
            <span id="metric-overprint" class="valor">--</span>
          </li>
        </ul>
        <div class="cobertura-cmyk">
          <h4>Cobertura CMYK detectada</h4>
          <ul id="metric-coverage" class="coverage-list"></ul>
        </div>
      </div>
    </div>
    <ul id="riesgo-detalle" class="riesgo-detalle"></ul>
    <div id="sim-container">
      <canvas id="sim-canvas" data-sim-img="{{ sim_canvas_base }}"></canvas>
      <pre id="sim-debug" style="display:none"></pre>
    </div>
    <div class="sim-actions">
      <button id="sim-save" class="btn" type="button">üñºÔ∏è Generar PNG final</button>
      <a id="sim-view" class="btn" href="{{ url_for('static', filename=sim_img_web) }}" target="_blank" rel="noopener">üîç Ver imagen completa</a>
    </div>
  </section>

  <div class="botones">
    <a href="{{ url_for('static', filename=imagen_iconos_web) }}" class="btn" download>‚¨á Descargar imagen con advertencias</a>
    <a href="{{ url_for('revision') }}" class="btn">‚¨Ö Volver a revisar otro dise√±o</a>
  </div>
  <script>
    window.diag_img_web = {{ diag_img_static|tojson }};
    window.revisionId = {{ (revision_id or '')|tojson }};
    window.diagnosticoJson = {{ diag|tojson }};
    window.analisisDetallado = {{ (analisis or {})|tojson }};
    window.indicadoresAdvertencias = {{ (indicadores_advertencias or diag_stats or {})|tojson }};
    window.advertenciasResumen = {{ (advertencias_txt or '')|tojson }};
  </script>
  <script src="{{ url_for('static', filename='js/flexo_simulation.js') }}?v={{ revision_id }}" defer></script>
</body>
</html>
